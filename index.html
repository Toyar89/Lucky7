<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>LUCKY 7</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#17173A" />

  <!-- iOS support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-512.png">

  <style>
    :root { --bg:#17173A; --fg:#ffffff; --card:#ffffff; --accent:#ffffff; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      overscroll-behavior: none;
      -webkit-text-size-adjust: none;
      touch-action: manipulation;
      font-family: Arial, sans-serif;
    }

    .app {
      min-height: 100vh;
      min-height: 100svh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding:
        env(safe-area-inset-top)
        env(safe-area-inset-right)
        env(safe-area-inset-bottom)
        env(safe-area-inset-left);
    }

    .app-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }

    .logo {
      width: clamp(160px, 30vw, 360px);
      height: auto;
      display: block;
      margin: 0 auto 18px;
      padding-top: env(safe-area-inset-top, 0);
    }

    .cards {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
    }

    .card-container { perspective: 1000px; }

    .card-inner {
      width: clamp(90px, 12vw, 120px);
      height: clamp(150px, 21vw, 200px);
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      cursor: pointer;
    }
    .card.flipped .card-inner { transform: rotateY(180deg); cursor: default; }

    .card-face {
      position: absolute; width: 100%; height: 100%;
      border-radius: 12px; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: clamp(28px, 4vw, 48px); font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .card-front { background: royalblue; border: 3px solid #fff; box-sizing: border-box; }
    .card-back  { background: var(--card); color: #000; border: 3px solid #fff; box-sizing: border-box; transform: rotateY(180deg); position: relative; }

    .position-label { font-size: clamp(14px, 2vw, 18px); margin-top: 6px; color: var(--fg); }

    .scoreboard { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; }
    .scorebox { background: var(--card); color:#000; padding:10px 20px; border-radius:8px; font-size:18px; font-weight:bold; min-width:100px; text-align:center; }

    .button-row { display:flex; justify-content:center; align-items:center; gap:16px; margin-top:15px; }
    #howToPlayButton {
      padding:14px 40px; min-width:200px; font-size:20px; font-weight:bold;
      border-radius:8px; background: var(--bg); color: var(--fg);
      border:2px solid var(--accent); cursor:pointer;
    }
    #howToPlayButton:hover { background:#1e1e45; }

    @media (max-width:420px) {
      .button-row { gap:10px; }
      #howToPlayButton { padding:12px 26px; min-width:150px; font-size:18px; }
    }

    @keyframes winCardFlash { 0%,100%{background-color:gold} 50%{background-color:white} }
    .winFlash .card-back { animation: winCardFlash .4s alternate infinite; }
    @keyframes bustBackgroundFlash { 0%{background:rgba(255,0,0,.3)} 50%{background:rgba(255,0,0,.9)} 100%{background:rgba(255,0,0,.3)} }
    .card.bustFlash .card-back { animation: bustBackgroundFlash .6s infinite; color:#fff; }

    .bust-label { position:absolute; left:6px; right:6px; text-align:center; font-weight:900; color:#fff; letter-spacing:.08em; text-shadow:0 2px 4px rgba(0,0,0,.6); pointer-events:none; font-size:clamp(16px,2.5vw,22px); }
    .bust-label.top{ top:6px } .bust-label.bottom{ bottom:6px }

    .win-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10001; pointer-events:none; }

    /* üî• Updated YOU WIN style */
    .win-overlay .text {
      font-size: clamp(64px, 14vw, 200px);
      font-weight: 900;
      color: #FFD700; /* Solid gold */
      text-shadow:
        -4px -4px 0 #000,
         4px -4px 0 #000,
        -4px  4px 0 #000,
         4px  4px 0 #000,
         0px -5px 0 #000,
         0px  5px 0 #000,
        -5px  0px 0 #000,
         5px  0px 0 #000; /* Thicker outline */
      animation: winTextFlash 0.3s infinite alternate; /* Faster pulse */
    }
    @keyframes winTextFlash {
      0%   { transform: scale(1); }
      100% { transform: scale(1.08); }
    }

    .win-overlay.show { display:flex; }

    .copyright { font-size:1em; margin-top:10px; opacity:.8; }

    #howToPlayModal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.75); backdrop-filter:blur(2px); }
    #howToPlayModal.show { display:block; }
    body.modal-open { overflow:hidden; }

    #howToPlayContent {
      background:#1D1D3F; color:#fff; margin:8% auto; padding:20px 22px; border-radius:12px;
      max-width:420px; width:calc(100% - 40px); text-align:left; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #howToPlayContent h2 { text-align:center; margin:0 0 10px; }
    #howToPlayContent p  { margin:8px 0; line-height:1.5; font-size:16px; }
    .howto-actions { text-align:center; margin-top:14px; }
    .howto-actions button { padding:10px 24px; background:var(--card); color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
    .howto-actions button:hover { background:#eee; }

    canvas.confetti { position:fixed; inset:0; pointer-events:none; }

    .card { transition: opacity 320ms ease; }
    .cards.fade-out .card { opacity:0; pointer-events:none; }

    /* Fullscreen toggle button */
    .fs-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 34px;
      height: 34px;
      line-height: 30px;
      text-align: center;
      font-size: 20px;
      font-weight: 900;
      color: #fff;
      background: rgba(0,0,0,0.35);
      border: 2px solid #fff;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10002;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      backdrop-filter: blur(2px);
    }
    .fs-toggle:active { transform: scale(0.96); }
  </style>
</head>

<body>
  <div class="app">
    <div class="app-inner">
      <img class="logo" src="logo.png?v=3" alt="Lucky 7"/>
      <div class="cards" id="cardContainer"></div>
      <div class="button-row">
        <button id="howToPlayButton" onclick="showHowToPlay()">How to Play</button>
      </div>
      <div class="scoreboard">
        <div class="scorebox">Won: <span id="winCount">0</span></div>
        <div class="scorebox">Lost: <span id="loseCount">0</span></div>
      </div>
      <div class="copyright">¬© Kev Shirreffs 2025</div>
    </div>
  </div>

  <!-- Fullscreen toggle button -->
  <button id="fsToggle" class="fs-toggle" aria-label="Enter fullscreen" title="Enter fullscreen" hidden>‚õ∂</button>

  <!-- Overlays -->
  <div id="winOverlay" class="win-overlay"><div class="text">YOU WIN!</div></div>

  <!-- Modal -->
  <div id="howToPlayModal">
    <div id="howToPlayContent">
      <h2>How to Play</h2>
      <p>üéØ You have 7 facedown cards numbered <strong>1 to 7</strong> on the front.</p>
      <p>üîÑ The back of each card has a number (also <strong>1 to 7</strong>) in a random order.</p>
      <p>üÉè Start by picking any card.</p>
      <p>üìç The number you reveal tells you which <strong>position</strong> you must flip next.</p>
      <p>üèÜ Reveal <strong>all 7 cards</strong> without repeating a position to win.</p>
      <p>‚ùå If a number points to a card that‚Äôs already face-up, you <strong>bust</strong> and lose.</p>
      <div class="howto-actions"><button onclick="closeHowToPlay()">Got it!</button></div>
    </div>
  </div>

  <!-- Update banner -->
  <div id="updateBanner" style="
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #1D1D3F; color: #fff;
    padding: 12px 16px; display: none;
    justify-content: space-between; align-items: center;
    font-size: 16px; z-index: 10005;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.4);
  ">
    <span>‚ú® A new version is available</span>
    <button id="reloadBtn" style="
      background: #FFD700; color: #000;
      border: none; border-radius: 6px;
      padding: 6px 12px; font-weight: bold; cursor: pointer;
    ">Update now</button>
  </div>

  <!-- Game logic -->
  <script src="app.js"></script>

  <!-- Viewport height patch -->
  <script>
    (function ensureFullHeight() {
      const app = document.querySelector('.app');
      const supportsDVH = window.CSS && CSS.supports && (CSS.supports('height: 100dvh') || CSS.supports('min-height: 100dvh'));
      function applyPX() {
        const h = window.innerHeight || document.documentElement.clientHeight || screen.height;
        app.style.height = h + 'px';
        app.style.minHeight = h + 'px';
      }
      if (!supportsDVH) {
        applyPX(); setTimeout(applyPX, 200); setTimeout(applyPX, 600);
        window.addEventListener('resize', applyPX, { passive: true });
        window.addEventListener('orientationchange', applyPX, { passive: true });
        document.addEventListener('visibilitychange', () => { if (!document.hidden) setTimeout(applyPX, 100); });
      }
    })();
  </script>

  <!-- Fullscreen toggle -->
  <script>
    (function fullscreenToggle() {
      const btn = document.getElementById('fsToggle');
      const root = document.documentElement;
      const hasFS = !!document.fullscreenEnabled;
      if (!hasFS) return;
      btn.hidden = false;
      function updateLabel() {
        const active = !!document.fullscreenElement;
        btn.title = active ? 'Exit fullscreen' : 'Enter fullscreen';
        btn.setAttribute('aria-label', btn.title);
        btn.innerText = active ? '√ó' : '‚õ∂';
      }
      async function toggleFullscreen() {
        try {
          if (!document.fullscreenElement) await root.requestFullscreen();
          else await document.exitFullscreen();
        } catch (e) { console.error('Fullscreen toggle failed:', e); }
        finally { updateLabel(); }
      }
      btn.addEventListener('click', toggleFullscreen);
      document.addEventListener('fullscreenchange', updateLabel);
      updateLabel();
    })();
  </script>

  <!-- SW with update banner -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js?v=v7').then(reg => {
        function showUpdateBanner(worker) {
          const banner = document.getElementById('updateBanner');
          const reloadBtn = document.getElementById('reloadBtn');
          if (!banner || !reloadBtn) return;
          banner.style.display = 'flex';
          reloadBtn.onclick = () => worker.postMessage('SKIP_WAITING');
        }
        if (reg.waiting) showUpdateBanner(reg.waiting);
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          if (!newSW) return;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateBanner(newSW);
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        });
      }).catch(console.error);
    }
  </script>
</body>
</html>
